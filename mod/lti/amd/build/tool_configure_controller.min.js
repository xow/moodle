define(["jquery","core/ajax","core/notification","core/templates","mod_lti/events","mod_lti/keys","mod_lti/tool_type","mod_lti/tool_proxy","core/str"],function(a,b,c,d,e,f,g,h,i){var j={REGISTRATION_FEEDBACK_CONTAINER:"#registration-feedback-container",EXTERNAL_REGISTRATION_CONTAINER:"#external-registration-container",EXTERNAL_REGISTRATION_PAGE_CONTAINER:"#external-registration-page-container",CARTRIDGE_REGISTRATION_CONTAINER:"#cartridge-registration-container",CARTRIDGE_REGISTRATION_FORM:"#cartridge-registration-form",ADD_TOOL_FORM:"#add-tool-form",TOOL_LIST_CONTAINER:"#tool-list-container",TOOL_CREATE_BUTTON:"#tool-create-button",REGISTRATION_CHOICE_CONTAINER:"#registration-choice-container",TOOL_URL:"#tool-url"},k=function(){return a(j.TOOL_CREATE_BUTTON)},l=function(){return a(j.REGISTRATION_FEEDBACK_CONTAINER)},m=function(){return a(j.TOOL_LIST_CONTAINER)},n=function(){return a(j.EXTERNAL_REGISTRATION_CONTAINER)},o=function(){return a(j.CARTRIDGE_REGISTRATION_CONTAINER)},p=function(){return a(j.REGISTRATION_CHOICE_CONTAINER)},q=function(){return a(j.TOOL_URL).val()},r=function(){n().addClass("hidden")},s=function(){o().addClass("hidden")},t=function(){p().addClass("hidden")},u=function(){s(),t(),n().removeClass("hidden"),w(n())},v=function(a){r(),t(),o().removeClass("hidden"),o().find(j.CARTRIDGE_REGISTRATION_FORM).attr("data-cartridge-url",a),w(o())},w=function(a){var b=a.children().clone(!0,!0);a.empty(),a.append(b)},x=function(){A()||(r(),s(),p().removeClass("hidden"),w(p()))},y=function(){m().addClass("hidden")},z=function(){m().removeClass("hidden")},A=function(){return a.trim(l().html())},B=function(a){d.render("mod_lti/registration_feedback",a).done(function(a){r(),s(),t();var b=l();b.append(a)}).fail(c.exception)},C=function(){var a=l();a.empty(),x()},D=function(a){a.addClass("loading")},E=function(a){a.removeClass("loading")},F=function(){var a=m();D(a),g.query().done(function(b){h.query({orphanedonly:!0}).done(function(e){d.render("mod_lti/tool_list",{tools:b,proxies:e}).done(function(b,c){a.empty(),a.append(b),d.runTemplateJS(c)}).fail(c.exception)}).fail(c.exception)}).fail(c.exception).always(function(){E(a)})},G=function(){var b=q();if(""===b)return a.Deferred().resolve();var d=k();D(d);var f=g.isCartridge(b);return f.always(function(){E(d)}),f.done(function(c){c.iscartridge?(a(j.TOOL_URL).val(""),a(document).trigger(e.START_CARTRIDGE_REGISTRATION,b)):a(document).trigger(e.START_EXTERNAL_REGISTRATION,{url:b})}),f.fail(function(){i.get_strings([{key:"error",component:"moodle"},{key:"errorbadurl",component:"mod_lti"}]).done(function(b){a(document).trigger(e.REGISTRATION_FEEDBACK,{status:b[0],message:b[1],error:!0})}).fail(c.exception)}),f},H=function(){a(document).on(e.NEW_TOOL_TYPE,function(){F()}),a(document).on(e.START_EXTERNAL_REGISTRATION,function(){u(),a(j.TOOL_URL).val(""),y()}),a(document).on(e.STOP_EXTERNAL_REGISTRATION,function(){z(),x(),F()}),a(document).on(e.START_CARTRIDGE_REGISTRATION,function(a,b){v(b)}),a(document).on(e.STOP_CARTRIDGE_REGISTRATION,function(){o().find(j.CARTRIDGE_REGISTRATION_FORM).removeAttr("data-cartridge-url"),x()}),a(document).on(e.REGISTRATION_FEEDBACK,function(a,b){B(b)});var b=a(j.ADD_TOOL_FORM);b.submit(function(a){a.preventDefault(),G()});var c=l();c.click(function(a){a.preventDefault(),C()}),c.keypress(function(a){a.metaKey||a.shiftKey||a.altKey||a.ctrlKey||(a.keyCode==f.ENTER||a.keyCode==f.SPACE)&&(a.preventDefault(),C())})};return{init:function(){H(),F()}}});