define(["jquery","core/ajax","core/notification","core/templates","mod_lti/events","mod_lti/tool_proxy","mod_lti/tool_type","mod_lti/keys"],function(a,b,c,d,e,f,g,h){var i={REGISTRATION_URL:"#external-registration-url",EXTERNAL_REGISTRATION_CONTAINER:"#external-registration-page-container",EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER:"#external-registration-template-container",EXTERNAL_REGISTRATION_CANCEL_BUTTON:"#cancel-external-registration",TOOL_TYPE_CAPABILITIES_CONTAINER:"#tool-type-capabilities-container",TOOL_TYPE_CAPABILITIES_TEMPLATE_CONTAINER:"#tool-type-capabilities-template-container",CAPABILITIES_AGREE_CONTAINER:".capabilities-container"},j=function(){return a(i.EXTERNAL_REGISTRATION_CONTAINER).attr("data-registration-url")},k=function(){return a(i.EXTERNAL_REGISTRATION_CANCEL_BUTTON)},l=function(){return a(i.EXTERNAL_REGISTRATION_CONTAINER)},m=function(){return a(i.EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER)},n=function(){return a(i.TOOL_TYPE_CAPABILITIES_CONTAINER)},o=function(){return a(i.TOOL_TYPE_CAPABILITIES_TEMPLATE_CONTAINER)},p=function(){n().addClass("loading")},q=function(){n().removeClass("loading")},r=function(){k().addClass("loading")},s=function(){k().removeClass("loading")},t=function(){n().addClass("hidden")},u=function(){n().removeClass("hidden")},v=function(){l().addClass("hidden")},w=function(){l().removeClass("hidden")},x=function(a){var b=k();b.attr("data-tool-proxy-id",a)},y=function(){var a=k();return a.attr("data-tool-proxy-id")},z=function(){var a=k();a.removeAttr("data-tool-proxy-id")},A=function(){return y()?!0:!1},B=function(a){var c={methodname:"mod_lti_get_tool_proxy_registration_request",args:{id:a}};return b.call([c])[0]},C=function(){r();var b=a.Deferred();if(A()){var c=y();f["delete"](c).done(function(){b.resolve()})}else b.resolve();return b.done(function(){H(),s()}),b},D=function(a){var b=d.render("mod_lti/tool_proxy_registration_form",a);return b.done(function(a,b){var c=m();c.append(a),d.runTemplateJS(b),c.find("form").submit(),w()}),b},E=function(a){return g.update({id:a.id,state:g.constants.state.configured})},F=function(b){var c=a.Deferred();return d.render("mod_lti/tool_type_capabilities_agree",b).done(function(a,f){var g=o();v(),d.replaceNodeContents(g,a,f),u();var h=g.find(i.CAPABILITIES_AGREE_CONTAINER);h.on(e.CAPABILITIES_AGREE,function(){p(),E(b).always(function(){q(),g.empty(),c.resolve()})}),h.on(e.CAPABILITIES_DECLINE,function(){g.empty(),c.resolve()})}),c.done(function(){t()}),c},G=function(){var b=a.Deferred(),c=j();return""===c?b.resolve():f.create({regurl:c}).done(function(a){var c=a.id,d=a.regurl;x(c),B(c).done(function(a){a.reg_url=d,D(a).done(function(){b.resolve()}).fail(b.fail)}).fail(b.fail)}).fail(function(c){C(),a(document).trigger(e.REGISTRATION_FEEDBACK,{status:"error",message:c.message,error:!0}),b.fail(c)}),b},H=function(){A()&&z(),v();var b=m();b.empty(),a(document).trigger(e.STOP_EXTERNAL_REGISTRATION)},I=function(){a(document).on(e.START_EXTERNAL_REGISTRATION,function(){G()});var b=k();b.click(function(a){a.preventDefault(),C()}),b.keypress(function(a){a.metaKey||a.shiftKey||a.altKey||a.ctrlKey||(a.keyCode==h.ENTER||a.keyCode==h.SPACE)&&(a.preventDefault(),C())}),window.triggerExternalRegistrationComplete=function(b){var c=a.Deferred(),d={status:b.status,message:"",error:!1};if("success"==b.status){if(d.message=b.message,c.done(function(){H(),a(document).trigger(e.REGISTRATION_FEEDBACK,d),a(document).trigger(e.NEW_TOOL_TYPE)}),A()){var f=y();g.getFromToolProxyId(f).done(function(a){if(a&&a.length){var b=a[0];b.hascapabilitygroups?F(b).always(function(){c.resolve()}):c.resolve()}else c.resolve()}).fail(function(){c.resolve()})}}else d.message=b.error,d.error=!0,c.done(function(){C().always(function(){a(document).trigger(e.REGISTRATION_FEEDBACK,d)})}),c.resolve();return c}};return{init:function(){I()}}});