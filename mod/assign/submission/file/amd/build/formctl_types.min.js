define(["jquery","core/yui","core/str","core/notification","core/ajax","core/templates"],function(a,b,c,d,e,f){"use strict";function g(b,c){var d=b.value,e=b.checked;d.indexOf("/")>=0?a(c).find("input[type=checkbox]").filter(function(){return this.value===d}).prop("checked",e):a(b).parentsUntil(c,".filetypegroup").toggleClass("selected",e)}function h(a,b,c,e){var g,h=a.attr("value").split(";"),i={hasitems:!1,items:[]};for(g=0;g<h.length;g++)if(e[h[g]])i.items.push(e[h[g]]);else{if(!c[h[g]])continue;i.items.push(c[h[g]])}i.hasitems=i.items.length>0,f.render("assignsubmission_file/label",i).done(function(a){b.html(a)}).fail(d.excetion)}function i(b,c){var d=[];a(c).find("input[type=checkbox]").each(function(){this.checked&&d.indexOf(this.value)<0&&d.push(this.value)}),b.attr("value",d.join(";"))}function j(c,e,j,l,m){function n(a){var b={typekey:a,selected:q.indexOf(a)>=0,name:m[a].name,extlist:m[a].extlist};p.types.push(b)}var o,p,q=e.attr("value").split(";"),r={groups:[]};for(o in l)void 0!==l[o]&&(l[o].types.length<1||(p={groupkey:o,name:l[o].name,extlist:l[o].extlist,isoption:"-"!==o&&l[o].isoption,selected:q.indexOf(o)>=0,types:[]},l[o].types.forEach(n),r.groups.push(p)));f.render("assignsubmission_file/selector",r).done(function(d){var f;b.use("moodle-core-notification-dialogue",function(){var a=new M.core.dialogue({bodyContent:d,headerContent:"<h3>"+c+"</h3>",modal:!0,extraClasses:["formctl_types_chooser"]});f=a.bodyNode.getDOMNode(),a.addButton({name:"save",label:k,action:function(){i(e,f),h(e,j,l,m),a.hide()}}),a.show(),a.after("visibleChange",function(){a.destroy(!0)})}),a(f).delegate("input[type=checkbox]","change",function(a){g(a.target,f)})}).fail(d.exception)}var k;return c.get_string("formctl_types_save","assignsubmission_file").done(function(a){k=a}).fail(d.exception),{initialise:function(b,c,f){var g=a(document.getElementById(b)),i=a(document.getElementById(b+"_label")),k=a(document.getElementById(b+"_choose"));if(g.length&&i.length&&k.length){var l=[{methodname:"assignsubmission_file_get_types_and_groups",args:{filetypes:f},done:function(a){var b={},d={};a.typegroups.forEach(function(a){b[a.id]=a}),a.alltypes.forEach(function(a){d[a.id]=a}),h(g,i,b,d),k.on("click",function(){j(c,g,i,b,d)})},fail:d.exception}];e.call(l,!0,!1)}}}});