define(["jquery","core/yui","core/str","core/notification","core/ajax","core/templates"],function(a,b,c,d,e,f){"use strict";function g(b){if(0===b.target.value.indexOf("."))a(b.data).find("input[type=checkbox]").filter(function(a,c){return c.value===b.target.value}).prop("checked",b.target.checked);else{var c=a(b.target).closest(".filetypegroup",b.data);if(c.toggleClass("selected",b.target.checked),"*"===c.attr("data-groupkey")){var d=c.closest(".form-filetypes-selector",b.data);d.toggleClass("allselected",b.target.checked),b.target.checked&&d.find('.filetypegroup:not([data-groupkey="*"]) input[type=checkbox]').each(function(a,b){b.checked=!1})}else b.target.checked&&c.find("ul input[type=checkbox]").each(function(c,d){a(b.data).find('input[type=checkbox][value="'+d.value+'"]').prop("checked",!1)})}}function h(a,b,c,e){var g,h,i={items:[]};for(h=0;h<a.length;h++)g=e[a[h]]||c[a[h]],g&&i.items.push(g);f.render("core/form_filetypes_label",i).done(function(a){b.html(a)}).fail(d.excetion)}function i(b){var c=[];return a(b).find("input[type=checkbox]").each(function(a,b){b.checked&&c.indexOf(b.value)<0&&c.push(b.value)}),c}function j(e,j,k,l,m){function n(a){var b={typekey:a,selected:t.indexOf(a)>=0,name:m[a].name,extlist:m[a].extlist};p.types.push(b)}var o,p,q,r,s,t=j.attr("value").replace(" ","").split(","),u={groups:[]};for(o in l)void 0!==l[o]&&(l[o].types.length<1&&"*"!==o||(p={groupkey:o,name:l[o].name,extlist:l[o].extlist,isoption:"-"!==o&&l[o].isoption,selected:t.indexOf(o)>=0,types:[]},l[o].types.forEach(n),u.groups.push(p),t.indexOf(o)>=0&&"*"===o&&(u.allselected=!0)));q=c.get_string("savechoices","form"),r=c.get_string("cancel","moodle"),s=f.render("core/form_filetypes_selector",u),a.when(q,r,s).then(function(c,d,f){var n;b.use("moodle-core-notification-dialogue",function(){var a=new M.core.dialogue({bodyContent:f[0],headerContent:e,draggable:!0,modal:!0,extraClasses:["form-filetypes-chooser"]});n=a.bodyNode.getDOMNode(),a.addButton({name:"save",label:c,action:function(){var b=i(n);h(b,k,l,m),j.attr("value",b.join(",")),"undefined"!=typeof M.core_formchangechecker&&M.core_formchangechecker.set_form_changed(),a.hide()},section:b.WidgetStdMod.FOOTER}),a.addButton({label:d,action:function(b){b.preventDefault(),a.hide()},section:b.WidgetStdMod.FOOTER}),a.show(),a.after("visibleChange",function(){a.destroy(!0)})}),a(n).on("change","input[type=checkbox]",n,g)},d.exception)}return{initialise:function(b,c,f,g){var h,i=a(document.getElementById(b)),k=a(document.getElementById(b+"_label")),l=a(document.getElementById(b+"_choose"));1==i.length&&1==k.length&&1==l.length&&l.on("click",function(){void 0===h&&(h=a.Deferred(),e.call([{methodname:"core_get_form_file_types_and_groups",args:{filetypes:f,allowall:g,lang:a("html").attr("lang").replace("-","_")},done:function(a){var b={},c={};a.typegroups.forEach(function(a){b[a.id]=a}),a.alltypes.forEach(function(a){c[a.id]=a}),h.resolve(b,c)},fail:d.exception}],!0,!1)),h.done(function(a,b){j(c,i,k,a,b)})})}}});