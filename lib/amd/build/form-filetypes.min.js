define(["jquery","core/yui","core/str","core/notification","core/ajax","core/templates"],function(a,b,c,d,e,f){"use strict";function g(b){0===b.target.value.indexOf(".")?a(b.data).find("input[type=checkbox]").filter(function(a,c){return c.value===b.target.value}).prop("checked",b.target.checked):a(b.target).closest(".filetypegroup",b.data).toggleClass("selected",b.target.checked)}function h(a,b,c,e){var g,h,i={items:[]};for(h=0;h<a.length;h++)g=e[a[h]]||c[a[h]],g&&i.items.push(g);f.render("core/form_filetypes_label",i).done(function(a){b.html(a)}).fail(d.excetion)}function i(b){var c=[];return a(b).find("input[type=checkbox]").each(function(a,b){b.checked&&c.indexOf(b.value)<0&&c.push(b.value)}),c}function j(e,j,k,l,m){function n(a){var b={typekey:a,selected:t.indexOf(a)>=0,name:m[a].name,extlist:m[a].extlist};p.types.push(b)}var o,p,q,r,s,t=j.attr("value").replace(" ","").split(","),u={groups:[]};for(o in l)void 0!==l[o]&&(l[o].types.length<1||(p={groupkey:o,name:l[o].name,extlist:l[o].extlist,isoption:"-"!==o&&l[o].isoption,selected:t.indexOf(o)>=0,types:[]},l[o].types.forEach(n),u.groups.push(p)));q=c.get_string("savechoices","form"),r=c.get_string("cancel","moodle"),s=f.render("core/form_filetypes_selector",u),a.when(q,r,s).then(function(c,d,f){var n;b.use("moodle-core-notification-dialogue",function(){var a=new M.core.dialogue({bodyContent:f[0],headerContent:e,draggable:!0,modal:!0,extraClasses:["form-filetypes-chooser"]});n=a.bodyNode.getDOMNode(),a.addButton({name:"save",label:c,action:function(){var b=i(n);h(b,k,l,m),j.attr("value",b.join(",")),a.hide()},section:b.WidgetStdMod.FOOTER}),a.addButton({label:d,action:function(b){b.preventDefault(),a.hide()},section:b.WidgetStdMod.FOOTER}),a.show(),a.after("visibleChange",function(){a.destroy(!0)})}),a(n).on("change","input[type=checkbox]",n,g)},d.exception)}return{initialise:function(b,c,f){var g,h=a(document.getElementById(b)),i=a(document.getElementById(b+"_label")),k=a(document.getElementById(b+"_choose"));1==h.length&&1==i.length&&1==k.length&&k.on("click",function(){void 0===g&&(g=a.Deferred(),e.call([{methodname:"core_get_form_file_types_and_groups",args:{filetypes:f,lang:a("html").attr("lang").replace("-","_")},done:function(a){var b={},c={};a.typegroups.forEach(function(a){b[a.id]=a}),a.alltypes.forEach(function(a){c[a.id]=a}),g.resolve(b,c)},fail:d.exception}],!0,!1)),g.done(function(a,b){j(c,h,i,a,b)})})}}});